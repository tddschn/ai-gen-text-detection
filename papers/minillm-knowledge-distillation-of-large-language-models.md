License: CC BY 4.0
arXiv:2306.08543v2 [cs.CL] 28 Feb 2024
MiniLLM: Knowledge Distillation of Large Language Models
Yuxian Gu
1
,
2
,    Li Dong
2
,    Furu Wei
2
,    Minlie Huang
1

1
The CoAI Group, Tsinghua University
2
Microsoft Research
guyx21@mails.tsinghua.edu.cn    {lidong1,fuwei}@microsoft.com
aihuang@tsinghua.edu.cn
Contribution during an internship at Microsoft Research.Corresponding author.
Abstract
Knowledge Distillation (KD) is a promising technique for reducing the high computational demand of large language models (LLMs). However, previous KD methods are primarily applied to white-box classification models or training small models to imitate black-box model APIs like ChatGPT. How to effectively distill the knowledge of white-box LLMs into small models is still under-explored, which becomes more important with the prosperity of open-source LLMs. In this work, we propose a KD approach that distills LLMs into smaller language models. We first replace the forward Kullback-Leibler divergence (KLD) objective in the standard KD approaches with reverse KLD, which is more suitable for KD on generative language models, to prevent the student model from overestimating the low-probability regions of the teacher distribution. Then, we derive an effective optimization approach to learn this objective. The student models are named MiniLLM. Extensive experiments in the instruction-following setting show that MiniLLM generates more precise responses with higher overall quality, lower exposure bias, better calibration, and higher long-text generation performance than the baselines. Our method is scalable for different model families with 120M to 13B parameters. Our code, data, and model checkpoints can be found in https://github.com/microsoft/LMOps/tree/main/minillm.

Refer to caption
Figure 1:The comparison of MiniLLM with the sequence-level KD (SeqKD; 36, 67, 15, 53, 22, 81) in terms of the average GPT-4 feedback score on our evaluation sets. Left: GPT-2-1.5B as the teacher model and GPT-2 125M, 340M, 760M as the student models. Middle: GPT-J 6B as the teacher model and GPT-2 760M, 1.5B, GPT-Neo 2.7B as the student models. Right: OPT 13B as the teacher and OPT 1.3B, 2.7B, 6.7B as the student models.
1Introduction
With the rapid development of large language models (LLMs; 7, 29, 4, 16, 50), a common technique to reduce their high computational resource demand is knowledge distillation (KD; 28), where we train a small student model with supervision from a large teacher model. Two categories of KD are commonly applied: black-box KD, where only the teacher-generated texts are accessible, and white-box KD, where the teacher model’s output distribution or intermediate hidden states are also available [30]. Recently, black-box KD has shown promising results in fine-tuning small models on the prompt-response pairs generated by LLM APIs [67, 15, 79, 53]. With the emergence of more open-source LLMs [83, 68], white-box KD becomes more valuable for both research communities and industry sectors because student models receive better signals from the output distribution and hidden states of teacher models, thereby potentially resulting in higher performance. However, white-box KD approaches are mostly studied for small (
<
 1B parameters) language understanding models [58, 78], while white-box KD for LLMs is yet to be explored.

In this work, we investigate white-box KD of LLMs where the output distribution of the teacher model is available. We argue that the standard KD objectives [36, 63, 15, 67] are sub-optimal for LLMs that perform tasks in a generative manner. Given the teacher distribution 
𝑝
⁢
(
𝒚
|
𝒙
)
 and the student distribution 
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
 parameterized by 
𝜃
, standard KD objectives (including several variants for sequence-level models) essentially minimize the approximated forward Kullback-Leibler divergence (KLD) between the teacher and the student distribution, termed as 
KL
[
𝑝
|
|
𝑞
𝜃
]
, which forces 
𝑞
𝜃
 to cover all modes of 
𝑝
. For text classification tasks, 
KL
[
𝑝
|
|
𝑞
𝜃
]
 works well because the output space usually consists of a finite number of classes such that both 
𝑝
⁢
(
𝒚
|
𝒙
)
 and 
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
 have few modes. However, for open-ended text generation tasks, which is usually the case of LLM applications, the output spaces are much more complex and 
𝑝
⁢
(
𝒚
|
𝒙
)
 can contain many more modes than what 
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
 can express due to the limited model capacity. Minimizing forward KLD causes 
𝑞
𝜃
 to assign unreasonably high probabilities to the void regions of 
𝑝
 [46] and produces very unlikely samples under 
𝑝
 during free-run generation [27].

Refer to caption
Figure 2:The toy experiment. We fit a Gaussian mixture distribution with a single Gaussian distribution using forward KLD and reverse KLD.
To alleviate this problem, we propose to minimize reverse KLD, 
KL
[
𝑞
𝜃
|
|
𝑝
]
, widely used in computer vision [43] and reinforcement learning [17]. Compared to 
KL
[
𝑝
|
|
𝑞
𝜃
]
, minimizing 
KL
[
𝑞
𝜃
|
|
𝑝
]
 causes 
𝑞
𝜃
 to seek the major modes of 
𝑝
, and assign low probabilities to 
𝑝
’s void regions [44], as illustrated in Table 2 and discussed in Section 2.1. In LLM text generation, this means that the student model avoids learning too many long-tail variants [23] in the teacher model’s distribution and focuses on the correctness of the generated cotents, which is critical in practical scenarios that require truthfulness and reliability [33]. To optimize 
min
𝜃
KL
[
𝑞
𝜃
|
|
𝑝
]
, as shown in Section 2.2, we derive the gradient of the objective with Policy Gradient [60]. To further stabilize and accelerate training, we propose (1) single-step decomposition to reduce variance, (2) teacher-mixed sampling to alleviate reward hacking, and (3) length normalization to eliminate the length bias. Finally, we introduce the overall KD algorithm in Section 2.3. Our student models are named MiniLLM, indicating our method is suitable and works well for compressing large (generative) language models.

We apply our method to various generative language models [56, 83, 68] with sizes ranging from 120M to 13B in the instruction-following setting [65, 71] that covers a large range of NLP tasks. We use 5 datasets with Rouge-L [39], the GPT-4 feedback, and human judgment for evaluation. Experiments show that MiniLLM consistently outperforms standard KD baselines on all the datasets and scales up well from 120M to 13B models (see Figure 1). More analysis shows that MiniLLM yields lower exposure bias, better calibration, and higher long response generation performance, with neglectable loss of diversity.

2Method
We consider conditional text generation where the model produces a response 
𝒚
=
{
𝑦
𝑡
}
𝑡
=
1
𝑇
 conditioning on a prompt 
𝒙
 sampled from the distribution 
𝑝
𝒙
, which is typically how LLMs perform tasks. We formulate KD as an optimization problem to minimize the difference between a fixed teacher model distribution 
𝑝
⁢
(
𝒚
|
𝒙
)
 and a student model distribution 
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
 parameterized by 
𝜃
. The standard KD methods approximately1 minimize the forward KLD: 
KL
[
𝑝
|
|
𝑞
𝜃
]
=
𝔼
𝒙
∼
𝑝
𝒙
,
𝒚
∼
𝑝
′
log
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
, where 
𝑝
′
 can be real data distribution (word-level KD) or teacher distribution 
𝑝
 (sequence-level KD). Though widely used, 
KL
[
𝑝
|
|
𝑞
𝜃
]
 tends to overestimate the void regions of 
𝑝
 in text generation tasks when 
𝑞
𝜃
 is insufficiently expressive [32]. KD for LLMs fits the case because LLMs perform tasks in a generative manner, such that the low-capacity student models cannot perfectly imitate the complex text generation distribution of the teacher models or humans.

2.1MiniLLM: Knowledge Distillation with Reverse KLD
We consider minimizing the reverse KLD between the student and teacher model distributions as the learning objective for MiniLLM:

𝜃
=
arg
⁡
min
𝜃
⁡
ℒ
⁢
(
𝜃
)
=
arg
min
𝜃
KL
[
𝑞
𝜃
|
|
𝑝
]
(1)
=
arg
⁡
min
𝜃
⁡
[
−
𝔼
𝒙
∼
𝑝
𝒙
,
𝒚
∼
𝑞
𝜃
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
]
.
Minimizing reverse KLD has been shown to cause the mode-seeking behavior in generative modeling [27, 47, 11, 43], where 
𝑞
𝜃
 assigns high probabilities to 
𝑝
’s large modes and ignore the small ones (illustrated in a toy experiment in Figure 2). In this work, we first study this property for KD of LLMs in text generation. Minimizing forward KLD causes 
𝑞
𝜃
 to place large probability masses on the zero-probability regions of 
𝑝
, corresponding to the generation of low-quality text in practice, while reverse KLD focuses on 
𝑝
’s major modes, which is crucial to ensure the correctness and faithfulness of text generation. As illustrated in Figure 3, unlike sequence-level KD that minimizes forward KLD [36, 67], MiniLLM that minimizes reverse KLD does not force 
𝑞
𝜃
 to fit all 
𝒚
 sampled from the teacher distribution 
𝑝
. Instead, it encourages the student to generate samples preferred by the teacher within its own capacities, which is more possible to achieve. Interestingly, we also find another perspective of understanding MiniLLM motivated by Inverse Reinforcement Learning [82]. We present the related derivation in Appendix A.1.

Refer to caption
Figure 3:Comparison between sequence-level KD (left) and MiniLLM (right). Sequence-level KD forces the student to memorize all samples generated by the teacher model, while MiniLLM improves its generated texts with the teacher model’s feedback.
2.2Optimization with Policy Gradient
Gradient Derivation
We notice that the gradient of the objective function 
ℒ
⁢
(
𝜃
)
 in Equation (1) can be derived using the Policy Gradient Theorem [72, 26]:

∇
ℒ
⁢
(
𝜃
)
=
−
𝔼
𝒙
∼
𝑝
𝒙
,
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
(
𝑅
𝑡
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
,
(2)
where 
𝑇
=
|
𝒚
|
 and 
𝑅
𝑡
=
∑
𝑡
′
=
𝑡
𝑇
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
 is the accumulation of 
𝑟
𝑡
′
=
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
 that measures the quality of each step’s generation. Intuitively, the generated texts are supposed to have high probabilities under the teacher distribution by increasing 
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
, but simultaneously stay diverse by lowering 
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
. The expectation in Eq. 2 is computed by Monte-Carlo sampling. Full derivation can be found in Appendix A.2. However, policy gradient suffers from high variance and reward hacking [59], despite some subsequent solutions [64]. Besides, we notice that 
𝑅
𝑡
 favors short sentences, which causes the student model to output empty responses. Therefore, we propose three strategies to mitigate these problems.

Single-Step Decomposition
[17] has found that the single-step generation quality 
𝑟
𝑡
 is critical to the training variance because the error in the front tokens accumulates along the whole sentence. To pay more attention to 
𝑟
𝑡
, we re-write 
∇
ℒ
⁢
(
𝜃
)
 to decompose 
𝑟
𝑡
 from 
𝑅
𝑡
 and directly compute the gradient of 
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
 (see Appendix A.3 for the full derivation):

∇
ℒ
⁢
(
𝜃
)
=
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
[
−
∑
𝑡
=
1
𝑇
∇
⁢
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
]
+
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
[
−
∑
𝑡
=
1
𝑇
𝑅
𝑡
+
1
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
]
(3)
=
(
∇
ℒ
)
Single
+
(
∇
ℒ
)
Long
,
where 
𝑞
𝜃
(
𝑡
)
=
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
. Note that 
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
 can be computed directly by summing over the vocabulary instead of using Monte-Carlo sampling and is derivable with respect to 
𝜃
. This decomposition gives a more precise and efficient estimation of the single-step generation quality, which reduces the variance during training and accelerates convergence.

Teacher-Mixed Sampling
We observe reward hacking [59] when training with Eq. 2 because 
𝑞
𝜃
 sometimes produces degenerated sentences 
𝒚
 that receive high scores from the teacher (e.g., repeated phrases) during sampling, especially for small student models. To create a better sampling distribution, we mix the teacher and the student distribution at each time step:

𝑝
~
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
=
𝛼
⋅
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
+
(
1
−
𝛼
)
⋅
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
,
(4)
where 
𝛼
 controls the strength of the teacher mix-in. Sampling from 
𝑝
~
 suppresses low-quality generation with the teacher’s help and alleviates reward hacking. We re-write 
(
∇
ℒ
)
Single
 and 
(
∇
ℒ
)
Long
 with importance sampling to get to an unbiased estimator of the gradient [54]:

(
∇
ℒ
)
Single
=
−
𝔼
𝒙
∼
𝑝
𝒙
,
𝒚
∼
𝑝
~
(
⋅
|
𝒙
)
[
∑
𝑡
=
1
𝑇
𝑤
𝑡
⁢
∇
⁢
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
]
,
(5)
(
∇
ℒ
)
Long
=
−
𝔼
𝒙
∼
𝑝
𝒙
,
𝒚
∼
𝑝
~
(
⋅
|
𝒙
)
[
∑
𝑡
=
1
𝑇
𝑤
𝑡
⁢
𝑅
𝑡
+
1
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
]
,
where 
𝑤
𝑡
=
∏
𝑡
′
=
1
𝑡
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑝
~
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
 is the importance weight. However, 
𝑤
𝑡
 brings high variance in practice because it requires multiplying per-token importance weight over multiple time steps, and thus the variance of each step accumulates. Therefore, we approximately set 
𝑤
𝑡
≈
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑝
~
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
 to reduce the variance of the estimator in Eq. 5 [62, 40].

Length Normalization
We found that long sequences tend to have small 
𝑅
𝑡
+
1
, which encourages the model to produce short responses. Therefore, we add length normalization to 
𝑅
𝑡
+
1
 in Eq. 3:

𝑅
𝑡
+
1
Norm
=
1
𝑇
−
𝑡
−
1
⁢
∑
𝑡
′
=
𝑡
+
1
𝑇
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
.
(6)
In Summary
Combining the strategies listed above, we have the final optimization gradient:

∇
ℒ
⁢
(
𝜃
)
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑝
~
(
⋅
|
𝒙
)
[
∑
𝑡
=
1
𝑇
𝑤
𝑡
⁢
[
∇
⁢
∑
𝑦
′
∈
𝑉
𝑞
𝜃
⁢
(
𝑦
′
|
𝒚
<
𝑡
,
𝒙
)
⁢
log
⁡
𝑝
⁢
(
𝑦
′
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
′
|
𝒚
<
𝑡
,
𝒙
)
⏟
(
∇
ℒ
)
Single
⁢
 part
+
𝑅
𝑡
+
1
Norm
⁢
∇
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
⏟
(
∇
ℒ
)
Long
Norm
⁢
 part
]
]
,
(7)
where 
𝑉
 is the vocabulary size of the language model and 
(
∇
ℒ
)
Long
Norm
 is 
(
∇
ℒ
)
Long
 with 
𝑅
𝑡
+
1
Norm
.

2.3Training Algorithm
We start from a student model pre-trained on a large long-document corpus 
𝒟
PT
. Algorithm 1 trains MiniLLM by adapting the student model to a text generation task with dataset 
𝒟
 and supervision from the teacher model, such as an LLM fine-tuned on 
𝒟
 [67, 15] or that with good task-generalization [12, 50]. In the training algorithm, we first fine-tune the student model on 
𝒟
 and pick the checkpoint with the lowest loss as an initialization for the following training. Then, we compute the gradients 
(
∇
ℒ
)
Single
 and 
(
∇
ℒ
)
Long
Norm
 based on Eq. 5 and Eq. 6, with a clipping strategy [64] added to further improve stability. Same as [51], we include a language modeling loss 
ℒ
PT
=
−
𝔼
𝒅
∼
𝒟
PT
log
⁡
𝑞
𝜃
⁢
(
𝒅
)
 to preserve the model performance on canonical NLP benchmarks. The student model is finally updated using a combination of gradients 
(
∇
ℒ
)
Single
+
(
∇
ℒ
)
Long
Norm
+
∇
ℒ
PT
. The whole training pipeline is similar to Reinforcement Learning from Human Feedback (RLHF; 51).

Algorithm 1 MiniLLM: Knowledge Distillation of LLMs
Conditional generation dataset 
𝒟
 consisting of prompts and ground-truth responses
   Pre-training corpus 
𝒟
PT
 consisting of long-document plain texts
   A teacher model with output distribution 
𝑝
   An initial student model pre-trained on 
𝒟
PT
, with the output distribution 
𝑞
𝜃
0
   Learning rate 
𝜂
;  Batch size 
𝑀
;  Clipping Threshold 
𝜖
A student model with the output distribution 
𝑞
𝜃
Fine-tune the student model from 
𝜃
0
 on 
𝒟
 supervised by the ground truth responses and choose 
𝜃
 with the lowest validation loss.
repeat
    Sample a mini-batch of prompts from 
𝒟
 and collect responses from 
𝑝
~
 to get 
𝒮
=
{
(
𝒙
𝑚
,
𝒚
𝑚
)
}
𝑚
=
1
𝑀
    Sample a mini-batch 
𝒟
′
PT
=
{
𝒅
𝑚
}
𝑚
=
1
𝑀
 from 
𝒟
PT
    Compute 
(
∇
ℒ
)
Single
=
−
1
𝑀
⁢
∑
𝒙
,
𝒚
∈
𝒮
∑
𝑡
=
1
𝑇
𝑤
𝑡
⁢
∇
⁢
∑
𝑦
𝑡
∈
𝑉
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
⁢
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
▷
 Eq. 5
    Compute 
(
∇
ℒ
)
Long
Norm
=
−
1
|
𝑀
|
⁢
∑
𝒙
,
𝒚
∈
𝒮
∑
𝑡
=
1
𝑇
𝑅
𝑡
+
1
Norm
⁢
∇
min
⁡
[
𝜌
𝑡
⁢
(
𝜃
)
,
clip
⁡
(
𝜌
𝑡
⁢
(
𝜃
)
,
1
−
𝜖
,
1
+
𝜖
)
]
,
    where 
𝜌
𝑡
⁢
(
𝜃
)
=
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑝
~
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
▷
 Eq. 5, Eq. 6
    Compute the gradient of the language modeling loss: 
∇
ℒ
PT
=
−
1
𝑀
⁢
∑
𝒅
∈
𝐷
PT
′
∇
log
⁡
𝑞
𝜃
⁢
(
𝒅
)
    Update model parameters: 
𝜃
←
𝜃
−
𝜂
⁢
[
(
∇
ℒ
)
Single
+
(
∇
ℒ
)
Long
Norm
+
∇
ℒ
PT
]
until converge and return 
𝑞
𝜃
3Experiments
3.1Experimental Setup
We take instruction-following [51] as the conditional text generation task, where models are trained to generate responses according to the instructions. We fine-tune a large model on the dataset 
𝒟
 consisting of instruction-response pairs as the teacher model. Then, we compare different KD methods on 
𝒟
 by evaluating the student model’s instruction-following performance.

Base Models
Our student models come from three model families with various sizes: GPT-2 [56] (120M, 340M, 760M), OPT [83] (1.3B, 2.7B, 6.7B), and LLaMA [68] (7B). For teacher models of each model family, we use GPT-2-1.5B, OPT-13B, and LLaMA-13B respectively. These models are fine-tuned on 
𝒟
 in advance. We also present the results using GPT-J [73] as the teacher model in Appendix C.1.

Training
We construct the training data from databricks-dolly-15K2 consisting of 15K human-written instruction-response pairs. We filter out samples that exceed the context length of the models. Then, we randomly split 0.5K and 1K samples for validation and testing, respectively, leaving about 12.5K examples for training. For 
𝒟
PT
, we use OpenWebText [20] for the GPT-2 family and the RoBERTa training corpus [42] for other models. We set the teacher-mix-in strength 
𝛼
=
0.2
 throughout the experiments in Eq. 4. We use Rouge-L [39] scores on the validation set to search for hyper-parameters because it aligns better with human preference than validation losses [76]. More details are shown in Appendix B.1.

Evaluation
We evaluate the trained models on five instruction-following datasets:

• DollyEval: the 500-sample test set we split from the databricks-dolly-15k dataset.
• SelfInst [74]: A user-oriented instruction-following set with 252 samples.
• VicunaEval [15]: The 80 challenging questions used in the Vicuna evaluation.
• S-NI: The test set of Super-NaturalInstructions [76] consisting of 9K samples ranging from 119 tasks. Following [53], we split the set into 3 subsets whose ground truth response lengths lie in 
[
0
,
5
]
, 
[
6
,
10
]
, and 
[
11
,
+
∞
]
. We use the 
[
11
,
+
∞
]
 subset in Section 1 and conduct an analysis on all subsets in Section 3.3.
• UnNI: The core set of UnnaturalInstructions [25] containing 60K samples. Similar to S-NI, we first conduct the evaluations on the 
[
11
,
+
∞
]
 subset, followed by an analysis of the performance on all subsets in Appendix C.3.
We adopt three metrics to evaluate the model-generated responses:

• R-L: The Rouge-L [39] score to measure the precision of the model generation. [76] has shown that Rouge-L is suitable for large-scale instruction-following evaluation.
• GPT4: The GPT-4 feedback [80] by asking GPT-4 to compare model-generated responses with the ground truth answers3 and raise 1-10 scores for both responses (see Appendix B.2 for the prompt we use). We report the ratio of the total score of model responses and ground truth answers. This metric is only applied to DollyEval, SelfInst, and VicunaEval.
• Human Evaluation: We conduct human evaluations on the SelfInst dataset following  [53] by asking volunteers to compare two responses produced by different models and annotate “Win”, “Tie”, or “Loss”. More human evaluation details can be found in Appendix B.3.
For all test sets, we sample the responses with the temperature = 1 and report the average scores of 5 generations for each prompt with different random seeds.

Baselines
We consider three baselines in our main experiment:

• SFT w/o KD directly fine-tunes the student model on 
𝒟
 supervised by the golden responses.
• KD [58, 63] fine-tunes the student model on 
𝒟
 using the teacher distribution as the supervision at each token step, also known as word-level KD.
• SeqKD [36, 15, 67, 53, 81] fine-tunes the student model on the data generated by the teacher model.
3.2Results
Model	#Params	Method	DollyEval	SelfInst	VicunaEval	S-NI	UnNI
GPT4	R-L	GPT4	R-L	GPT4	R-L	R-L	R-L
GPT-2	1.5B	Teacher	58.4	27.6	42.9	14.3	48.6	16.3	27.6	34.9
120M	SFT w/o KD	38.6	23.3	26.3	10.0	32.8	14.7	16.3	21.4
KD	40.3	22.8	27.8	10.8	31.9	13.4	19.7	24.8
SeqKD	41.2	22.7	26.2	10.1	31.0	14.3	16.4	21.0
MiniLLM	44.7	24.6	29.2	13.2	34.1	16.9*	25.3	30.1
340M	SFT w/o KD	51.9	25.5	39.6	13.0	42.3	16.0	25.1	32.0
KD	51.6	25.0	39.2	12.0	42.8	15.4	23.7	31.0
SeqKD	50.5	25.3	39.0	12.6	43.0	16.9*	22.9	30.2
MiniLLM	52.2	25.4	40.5	15.6	42.6	17.7*	27.4	34.5
760M	SFT w/o KD	50.7	25.4	38.3	12.4	43.1	16.1	21.5	27.1
KD	53.4	25.9	40.4	13.4	43.4	16.9*	25.3	31.7
SeqKD	52.0	25.6	38.9	14.0	42.4	15.9	26.1	32.9
MiniLLM	54.7	26.4	44.6*	15.9	45.7	18.3*	29.3*	37.7*
OPT	13B	Teacher	70.3	29.2	56.1	18.4	58.0	17.8	30.4	36.1
1.3B	SFT w/o KD	52.6	26.0	37.7	11.4	40.5	15.6	23.1	28.4
KD	52.7	25.4	36.0	12.2	40.8	14.9	21.9	27.0
SeqKD	51.0	26.1	36.6	12.7	42.6	16.6	21.4	28.2
MiniLLM	60.7	26.7	47.0	14.8	50.6	17.9*	28.6	33.4
2.7B	SFT w/o KD	55.4	27.1	38.9	13.9	44.8	16.6	24.9	32.3
KD	60.5	25.9	48.6	13.8	51.3	16.7	26.3	30.2
SeqKD	57.6	27.5	40.5	13.3	44.5	16.5	25.3	32.3
MiniLLM	63.2	27.4	52.7	17.2	55.9	19.1*	30.7*	35.1
6.7B	SFT w/o KD	67.9	27.6	56.4	16.4	57.3	17.8	30.3	28.6
KD	68.6	28.3	58.0	17.0	57.0	17.5	30.7*	26.7
SeqKD	69.6	28.5	54.0	17.0	57.6	17.9*	30.4	28.2
MiniLLM	70.8*	29.0	58.5*	17.5	60.1*	18.7*	32.5*	36.7*
LLaMA	13B	Teacher	79.0	29.7	75.5	23.4	65.1	19.4	35.8	38.5
7B	SFT w/o KD	73.0	26.3	69.2	20.8	61.6	17.5	32.4	35.8
KD	73.7	27.4	70.5	20.2	62.7	18.4	33.7	37.9
SeqKD	73.6	27.5	71.5	20.8	62.6	18.1	33.7	37.6
MiniLLM	76.4	29.0	73.1	23.2	64.1	20.7*	35.5	40.2*
Table 1:Evaluation results. GPT4 and R-L stand for the average GPT-4 feedback scores and Rouge-L scores across 5 random seeds, respectively. The best scores of each model size are boldfaced, and the scores where the student model outperforms the teacher are marked with *.
We present the R-L and GPT4 evaluation results in Table 1, from which we have three observations.

First, by comparing the overall performance of MiniLLM with the baselines, we observe that the model distilled by our KD method outperforms the baselines in almost all cases, when trained with different base models, tested on various evaluation sets, and scored by both Rouge-L and GPT-4 feedback. This verifies the good generalization and high overall performance of our KD method. We also find that MiniLLM generally works much better on datasets other than Dolly compared with the baselines, indicating its good out-of-distribution generalization.

Second, the Rouge-L scores show that MiniLLM produces the most precise responses that have high overlaps with the ground-truth responses. In some cases, especially on Vicuna, S-NI, and UnNI, student models reach even higher Rouge-L scores than the teacher models, which matches the observation in [19]. We conjecture that the standard teacher-forcing fine-tuning on 
𝒟
 brings training-inference discrepancy to the teacher model, also known as exposure bias [9]. On the contrary, MiniLLM is optimized with policy optimization methods, which samples responses from student models during training and thus alleviates exposure bias [52]. We include further analysis on exposure bias in Section 3.3.

Refer to caption
Figure 4:Human evaluation results. We use LLaMA-7B as the student and LLaMA-13B as the teacher.
Third, comparing the results across model sizes and model families, we can see that the improvement of MiniLLM is consistent when the base model sizes vary from 120M to 13B across three model families. This tendency is also illustrated in Figure 1, which demonstrates the excellent scalability and generalization of our method in the era of LLMs.

The human evaluation results on the SelfInst dataset based on the LLaMA family are shown in Figure 4. MiniLLM obtains better human preference than all the baselines, performing comparably to the teacher model.

3.3Analysis
Scaling Law of Teacher
Refer to caption
Figure 5:The scaling law of teacher based on the GPT-2 family models. We compare MiniLLM and SeqKD with GPT-2-125M as the student and GPT-2 340M, 760M, and 1.5B as teachers.
Although it is intuitive that we can distill better student models from larger teacher models, [45] has shown that increasing the teacher models’ sizes does not guarantee the improvement of student models, sometimes even harming the distillation performance. It is not clear how MiniLLM works when we scale up the teacher models’ sizes. Therefore, we compare MiniLLM and SeqKD using teacher models with different sizes and fix the size of the student model. We present the results based on the GPT-2 family in Figure 5 and that based on the OPT family in Appendix C.2. We can see that MiniLLM constantly outperforms SeqKD, and the student model performance is positively correlated with the teacher model sizes. This shows the potential of our method to compress models with massive parameters.

Exposure Bias
Language generation models trained to minimize forward KLD suffer from exposure bias [9] caused by the discrepancy between teacher-forcing training and free-run generation. When training MiniLLM, the student model sees samples generated by itself, alleviating the training-inference mismatch [52]. In Figure 6, we use the ExAccErr metric [2] defined in Appendix B.5 to measure the excess accumulated error due to exposure bias. The experiment is based on GPT-2-125M, with GPT-2-1.5B as the teacher, using Dolly as the test set. For each prompt, we sample 10 responses to reduce the variance. We can see that the ExAccErrs of the baselines continuously grow during generation, while MiniLLM has a much lower ExAccErr, and the error stops accumulating in long-text generation (
>
 150 tokens).

Figure 6:The excess error caused by the training-decoding discrepancy (ExAccErr) accumulated with the generation length. Lower ExAccErr means the method introduces less exposure bias.
Refer to caption
SST2	BoolQ
ECE	Acc.	ECE	Acc.
Teacher	0.025	93.0	0.356	74.5
KD	0.191	84.7	0.682	63.5
SeqKD	0.243	66.5	0.681	62.8
MiniLLM	0.099	89.7	0.502	67.8 
Figure 6:The excess error caused by the training-decoding discrepancy (ExAccErr) accumulated with the generation length. Lower ExAccErr means the method introduces less exposure bias.
Table 2:The ECE and accuracy scores on SST2 and BoolQ datasets. The best scores among student models are boldfaced.
Calibration
[50] has shown that models trained with policy optimization are likely to be poorly calibrated. We test the calibration of MiniLLM and the KD baselines on two widely-used text classification datasets: SST2 [61] and BoolQ [14], based on LLaMA-7B. We design zero-shot classification instructions (see Appendix B.2) and take the probability of the label words to compute the ECE scores [48]. From Table 6, we observe that KD and SeqKD models are worse calibrated than the teacher model, which potentially explains their low performance on canonical benchmarks [22]. We suspect that minimizing forward KLD causes the models to push high probabilities to void regions of the target distribution, which leads to significant distribution differences between the student and the teacher (see the example in Figure 2). In contrast, MiniLLM focuses on accurately learning the major parts of the target distribution and narrows the ECE scores gap between the student and the teacher.

Figure 7:The Rouge-L scores of the distilled models against SFT on the different subsets of S-NI split by the golden responses’ length.
Refer to caption
DollyEval	SelfInst
Dist-4	Loss	Dist-4	Loss
Teacher	99.3	3.55	99.1	4.44
SFT	99.5	3.89	99.0	5.28
MiniLLM	99.0	3.95	98.6	5.33 
Figure 7:The Rouge-L scores of the distilled models against SFT on the different subsets of S-NI split by the golden responses’ length.
Table 3:The distinct 4-grams (Dist-4) and language modeling loss (Loss) on the test sets based on the LLaMA family. MiniLLM preserves generation diversity.
Performance on Different Response Length
We study the models’ performance when the golden response lengths belong to different ranges. In Figure 7, we illustrate the Rouge-L scores of different KD models against the SFT models on three S-NI subsets split by the length of the ground truth responses. We can see that all methods achieve low scores on prompts that expect short responses (
≤
5
 tokens), probably because most responses in our training set are long sentences, introducing a distribution shift between training and evaluation [53]. Furthermore, the output spaces of these prompts are relatively small, allowing the student model to cover most modes of the teacher, and thus reverse KLD and forward KLD have similar performance. For prompts with longer responses (
≥
6
 tokens), the teacher distribution contains more modes than the students due to the complex output spaces, which shows the advantage of MiniLLM against standard KD models. Similar results on UnNI are shown in Appendix C.3.

Generation Diversity
[10] has found that the model optimized by minimizing reverse KLD is likely to lose modes, which affects the generation diversity. We follow [52] to discuss generation diversity from three aspects: (i) generating multiple distinct responses given a prompt. (ii) generating linguistically complex responses. (iii) the ability to generate contents that have high coverage of the real data distribution. For (i), we argue that for many NLP applications, generating one correct response is sufficient, especially for those scenarios demanding high truthfulness and reliability [33]. For (ii) and (iii), we report the responses’ distinct 4-gram proportion and the language modeling loss on the test sets in Table 7, using the base models from the LLaMA family (see Appendix B.4 for more details) . We can see that MiniLLM preserves the distinct 4-gram proportion in the generated responses and language modeling loss on the test set.

3.4Ablation Studies on Optimization Strategies
We evaluate the effectiveness of the three strategies proposed to stabilize and accelerate optimization in Section 2.2 by distilling a GPT-2-125M model from the GPT-2-1.5B model. More ablation studies can be found in Appendix C.4. In Table 8, we report the best Rouge-L scores on the validation set of each run and the evaluation results of the corresponding checkpoints. We also plot the reverse KLD between the student and the teacher during training in Figure 8, where the curves are smoothed by 32 steps. We can see that Teacher-Mixed Sampling and Length Normalization works for stabilizing training. Although the reverse KLDs also decrease without these strategies, we find that the models quickly learn to generate repeated, short, or meaningless strings that have high probabilities in the teacher distribution (see examples in Appendix D), which is known as reward hacking [59]. This also leads to the low generation performance in Table 8. From Figure 8, we also observe that the Single-Step Decomposition effectively reduces the variance of the training process, which also results in higher scores on the validation and test sets.

Table 4:The performance on the validation and test set when different combinations of MiniLLM optimization strategies are applied.
Valid.	Dolly
R-L	R-L
MiniLLM	27.4	24.6
  w/o Length Norm.	17.4	14.7
  w/o Teacher-Mixed	22.3	20.4
  w/o Single-Step	27.0	23.7 
Refer to caption
Table 4:The performance on the validation and test set when different combinations of MiniLLM optimization strategies are applied.
Figure 8:The reverse KLD between the teacher and the students during MiniLLM training when different optimization strategies are applied.
4Related Work
Large Language Models
Large language models (LLMs; 7, 66, 16, 50, 1) have shown superior performance by solving various NLP tasks in a generative manner. Recent works apply instruction tuning [71, 65, 12] or learning from human feedback [51, 5] to improve the alignment of LLMs with humans further and create general AI assistants [49, 21]. There are also efforts to build open-source LLMs [83, 68, 8] to facilitate research and industry development. Although appealing, the broad capacities of LLMs usually emerge with large model sizes [35, 77] that require massive computational resources. Therefore, model compression is critical for the practical deployment and further research of LLMs.

Knowledge Distillation
Knowledge distillation (KD; 28), as a widely used model compression technique, aims at training a student model with the guidance of a teacher model [55, 58, 30]. In the NLP community, many works apply KD to text classification tasks by mimicking the teacher model’s output distribution [63, 38, 84], hidden states [34, 57], or attention scores [78, 70]. For text generation, the standard KD method is to approximately minimize the forward KLD between the student’s and the teacher’s generation distribution by using the teacher’s output at each time step as supervision [58] or direct training on the teacher’s generated texts [36, 67, 15, 53]. In this paper, we minimize the reverse KLD, which is more suitable for LLMs when the teacher distribution is available. Concurrent works [3, 75] also explore more the distribution discrepancy metrics in KD.

Distribution Discrepancy Metrics in Text Generation
The distribution discrepancy metrics play a significant role in training text generation models. The forward KLD is widely used due to its simplicity when derived as the Maximum Likelihood Estimate (MLE) objective [85]. However, previous works show that minimizing forward KLD leads to zero-forcing behavior where models try to cover all modes of the target distribution and sacrifice the accuracy of major modes [27]. Some works resort to using other metrics to remedy this problem, such as reverse KLD [31], Total Variation Distance [32], and Optimal Transport [41]. Our paper tackles this problem under the scenario of knowledge distillation for LLMs.

5Conclusion
In this work, we investigate the problem of distilling the knowledge of LLMs into small language models. We find that the standard distillation methods minimizing the forward KLD is sub-optimal in language generation scenarios because the teacher’s output distribution contains more modes than the student’s, and forward KLD forces the student distribution to overestimate the low-probability regions of the teacher distribution. Therefore, we propose MiniLLM that minimizes the reverse KLD between the teacher and student distribution and design an algorithm to optimize this objective. Extensive experiments show that MiniLLM produce more precise responses that have higher overall quality than standard KD models. We also find that MiniLLM has lower exposure bias, better calibration, and higher performance in long-text generation with good generation diversity.

Acknowledgements
This work was supported by the National Key Research and Development Program of China (No. 2021ZD0113304), the National Science Foundation for Distinguished Young Scholars (with No. 62125604), and the NSFC projects (Key project with No. 61936010).

References
ADF
+
 [23]
Rohan Anil, Andrew M Dai, Orhan Firat, Melvin Johnson, Dmitry Lepikhin, Alexandre Passos, Siamak Shakeri, Emanuel Taropa, Paige Bailey, Zhifeng Chen, et al.Palm 2 technical report.arXiv preprint arXiv:2305.10403, 2023.
AEABC [22]
Kushal Arora, Layla El Asri, Hareesh Bahuleyan, and Jackie Cheung.Why exposure bias matters: An imitation learning perspective of error accumulation in language generation.In Findings of ACL, 2022.
AVS
+
 [23]
Rishabh Agarwal, Nino Vieillard, Piotr Stanczyk, Sabela Ramos, Matthieu Geist, and Olivier Bachem.GKD: Generalized knowledge distillation for auto-regressive sequence models.arXiv preprint arXiv:2306.13649, 2023.
BHA
+
 [21]
Rishi Bommasani, Drew A Hudson, Ehsan Adeli, Russ Altman, Simran Arora, Sydney von Arx, Michael S Bernstein, Jeannette Bohg, Antoine Bosselut, Emma Brunskill, et al.On the opportunities and risks of foundation models.arXiv preprint arXiv:2108.07258, 2021.
BJN
+
 [22]
Yuntao Bai, Andy Jones, Kamal Ndousse, Amanda Askell, Anna Chen, Nova DasSarma, Dawn Drain, Stanislav Fort, Deep Ganguli, Tom Henighan, et al.Training a helpful and harmless assistant with reinforcement learning from human feedback.arXiv preprint arXiv:2204.05862, 2022.
BLW
+
 [21]
Sid Black, Gao Leo, Phil Wang, Connor Leahy, and Stella Biderman.GPT-Neo: Large Scale Autoregressive Language Modeling with Mesh-Tensorflow, March 2021.
BMR
+
 [20]
Tom Brown, Benjamin Mann, Nick Ryder, Melanie Subbiah, et al.Language models are few-shot learners.In Proceedings of NeurIPS, 2020.
BSA
+
 [23]
Stella Biderman, Hailey Schoelkopf, Quentin Anthony, Herbie Bradley, Kyle O’Brien, Eric Hallahan, Mohammad Aflah Khan, Shivanshu Purohit, USVSN Sai Prashanth, Edward Raff, et al.Pythia: A suite for analyzing large language models across training and scaling.arXiv preprint arXiv:2304.01373, 2023.
BVJS [15]
Samy Bengio, Oriol Vinyals, Navdeep Jaitly, and Noam Shazeer.Scheduled sampling for sequence prediction with recurrent neural networks.In Proceedings of NeurIPS, 2015.
CCF
+
 [20]
Massimo Caccia, Lucas Caccia, William Fedus, Hugo Larochelle, Joelle Pineau, and Laurent Charlin.Language gans falling short.In ICLR, 2020.
CDP
+
 [18]
Liqun Chen, Shuyang Dai, Yunchen Pu, Erjin Zhou, Chunyuan Li, Qinliang Su, Changyou Chen, and Lawrence Carin.Symmetric variational autoencoder and connections to adversarial learning.In Proceedings of AISTATS, 2018.
CHL
+
 [22]
Hyung Won Chung, Le Hou, Shayne Longpre, Barret Zoph, Yi Tay, William Fedus, Eric Li, Xuezhi Wang, Mostafa Dehghani, Siddhartha Brahma, et al.Scaling instruction-finetuned language models.arXiv preprint arXiv:2210.11416, 2022.
Cio [21]
Kamil Ciosek.Imitation learning by reinforcement learning.In ICLR, 2021.
CLC
+
 [19]
Christopher Clark, Kenton Lee, Ming-Wei Chang, Tom Kwiatkowski, Michael Collins, and Kristina Toutanova.BoolQ: Exploring the surprising difficulty of natural yes/no questions.In Proceedings of NAACL-HLT, 2019.
CLL
+
 [23]
Wei-Lin Chiang, Zhuohan Li, Zi Lin, Ying Sheng, Zhanghao Wu, Hao Zhang, Lianmin Zheng, Siyuan Zhuang, Yonghao Zhuang, Joseph E. Gonzalez, Ion Stoica, and Eric P. Xing.Vicuna: An open-source chatbot impressing gpt-4 with 90%* chatgpt quality, March 2023.
CND
+
 [22]
Aakanksha Chowdhery, Sharan Narang, Jacob Devlin, Maarten Bosma, Gaurav Mishra, Adam Roberts, Paul Barham, Hyung Won Chung, Charles Sutton, Sebastian Gehrmann, et al.Palm: Scaling language modeling with pathways.arXiv preprint arXiv:2204.02311, 2022.
CPO
+
 [19]
Wojciech M Czarnecki, Razvan Pascanu, Simon Osindero, Siddhant Jayakumar, Grzegorz Swirszcz, and Max Jaderberg.Distilling policy distillation.In Proceedings of AISTATS, 2019.
CvdS [21]
Alex James Chan and Mihaela van der Schaar.Scalable bayesian inverse reinforcement learning.In ICLR, 2021.
FLT
+
 [18]
Tommaso Furlanello, Zachary Lipton, Michael Tschannen, Laurent Itti, and Anima Anandkumar.Born again neural networks.In Proceedings of ICML, 2018.
GCPT [19]
Aaron Gokaslan, Vanya Cohen, Ellie Pavlick, and Stefanie Tellex.Openwebtext corpus, 2019.
Goo [23]
Google.Bard, 2023.
GWS
+
 [23]
Arnav Gudibande, Eric Wallace, Charlie Snell, Xinyang Geng, Hao Liu, Pieter Abbeel, Sergey Levine, and Dawn Song.The false promise of imitating proprietary llms.arXiv preprint arXiv:2305.15717, 2023.
HBD
+
 [20]
Ari Holtzman, Jan Buys, Li Du, Maxwell Forbes, and Yejin Choi.The curious case of neural text degeneration.In Proceedings of ICLR, 2020.
HLM [22]
Yongchang Hao, Yuxin Liu, and Lili Mou.Teacher forcing recovers reward functions for text generation.In Proceeings of NeurIPS, 2022.
HSLS [23]
Or Honovich, Thomas Scialom, Omer Levy, and Timo Schick.Unnatural instructions: Tuning language models with (almost) no human labor.In Proceedings of ACL, 2023.
HTAL [17]
Tuomas Haarnoja, Haoran Tang, Pieter Abbeel, and Sergey Levine.Reinforcement learning with deep energy-based policies.In Proceedings of ICML, 2017.
Hus [15]
Ferenc Huszár.How (not) to train your generative model: Scheduled sampling, likelihood, adversary?arXiv preprint arXiv:1511.05101, 2015.
HVD [15]
Geoffrey Hinton, Oriol Vinyals, and Jeff Dean.Distilling the knowledge in a neural network.arXiv preprint arXiv:1503.02531, 2015.
HZD
+
 [21]
Xu Han, Zhengyan Zhang, Ning Ding, Yuxian Gu, et al.Pre-trained models: Past, present and future.AI Open, 2021.
JBMD [21]
Gou Jianping, Yu Baosheng, Stephen J Maybank, and Tao Dacheng.Knowledge distillation: A survey.IJCV, 2021.
JHC
+
 [20]
Haoming Jiang, Pengcheng He, Weizhu Chen, Xiaodong Liu, Jianfeng Gao, and Tuo Zhao.Smart: Robust and efficient fine-tuning for pre-trained natural language models through principled regularized optimization.In Proceedings ACL, 2020.
JKH
+
 [23]
Haozhe Ji, Pei Ke, Zhipeng Hu, Rongsheng Zhang, and Minlie Huang.Tailoring language generation models under total variation distance.In Proceedings of ICLR, 2023.
JLF
+
 [23]
Ziwei Ji, Nayeon Lee, Rita Frieske, Tiezheng Yu, Dan Su, Yan Xu, Etsuko Ishii, Ye Jin Bang, Andrea Madotto, and Pascale Fung.Survey of hallucination in natural language generation.ACM Computing Surveys, 2023.
JYS
+
 [20]
Xiaoqi Jiao, Yichun Yin, Lifeng Shang, Xin Jiang, Xiao Chen, Linlin Li, Fang Wang, and Qun Liu.Tinybert: Distilling bert for natural language understanding.In Findings of EMNLP, 2020.
KMH
+
 [20]
Jared Kaplan, Sam McCandlish, Tom Henighan, Tom B Brown, Benjamin Chess, Rewon Child, Scott Gray, Alec Radford, Jeffrey Wu, and Dario Amodei.Scaling laws for neural language models.arXiv preprint arXiv:2001.08361, 2020.
KR [16]
Yoon Kim and Alexander M Rush.Sequence-level knowledge distillation.In Proceedings of EMNLP, 2016.
LGB
+
 [16]
Jiwei Li, Michel Galley, Chris Brockett, Jianfeng Gao, and Bill Dolan.A diversity-promoting objective function for neural conversation models.In Kevin Knight, Ani Nenkova, and Owen Rambow, editors, Proceedings of NAACL, 2016.
LHS
+
 [21]
Kevin J Liang, Weituo Hao, Dinghan Shen, Yufan Zhou, Weizhu Chen, Changyou Chen, and Lawrence Carin.Mix{kd}: Towards efficient distillation of large-scale language models.In Proceedings of ICLR, 2021.
Lin [04]
Chin-Yew Lin.ROUGE: A package for automatic evaluation of summaries.In Proceedings of Text Summarization Branches Out (ACL 2004), 2004.
LKTF [20]
Sergey Levine, Aviral Kumar, George Tucker, and Justin Fu.Offline reinforcement learning: Tutorial, review, and perspectives on open problems.arXiv preprint arXiv:2005.01643, 2020.
LLW
+
 [20]
Jianqiao Li, Chunyuan Li, Guoyin Wang, Hao Fu, Yuhchen Lin, Liqun Chen, Yizhe Zhang, Chenyang Tao, Ruiyi Zhang, Wenlin Wang, et al.Improving text generation with student-forcing optimal transport.In Proceedings of EMNLP, 2020.
LOG
+
 [19]
Yinhan Liu, Myle Ott, Naman Goyal, Jingfei Du, Mandar Joshi, Danqi Chen, Omer Levy, Mike Lewis, Luke Zettlemoyer, and Veselin Stoyanov.RoBERTa: A robustly optimized BERT pretraining approach.arXiv preprint arXiv:1907.11692, 2019.
LPSK [23]
Hyoje Lee, Yeachan Park, Hyun Seo, and Myungjoo Kang.Self-knowledge distillation via dropout.Computer Vision and Image Understanding, 2023.
M
+
 [05]
Tom Minka et al.Divergence measures and message passing.Technical report, Citeseer, 2005.
MFL
+
 [20]
Seyed Iman Mirzadeh, Mehrdad Farajtabar, Ang Li, Nir Levine, Akihiro Matsukawa, and Hassan Ghasemzadeh.Improved knowledge distillation via teacher assistant.In Proceedings of AAAI, 2020.
MG [19]
Andrey Malinin and Mark Gales.Reverse KL-divergence training of prior networks: Improved uncertainty and adversarial robustness.In Proceedings of NeurIPS, 2019.
NCT [16]
Sebastian Nowozin, Botond Cseke, and Ryota Tomioka.f-gan: Training generative neural samplers using variational divergence minimization.In Proceedings of NeurIPS, 2016.
NDZ
+
 [19]
Jeremy Nixon, Michael W Dusenberry, Linchuan Zhang, Ghassen Jerfel, and Dustin Tran.Measuring calibration in deep learning.In CVPR workshops, 2019.
Ope [22]
OpenAI.OpenAI: Introducing ChatGPT, 2022.
Ope [23]
OpenAI.GPT-4 technical report, 2023.
OWJ
+
 [22]
Long Ouyang, Jeff Wu, Xu Jiang, Diogo Almeida, Carroll L Wainwright, Pamela Mishkin, Chong Zhang, Sandhini Agarwal, Katarina Slama, Alex Ray, et al.Training language models to follow instructions with human feedback.In Proceedings of NeurIPS, 2022.
PH [21]
Richard Yuanzhe Pang and He He.Text generation by learning from demonstrations.In Proceedings of ICLR, 2021.
PLH
+
 [23]
Baolin Peng, Chunyuan Li, Pengcheng He, Michel Galley, and Jianfeng Gao.Instruction tuning with GPT-4.arXiv preprint arXiv:2304.03277, 2023.
PSS [00]
Doina Precup, Richard S Sutton, and Satinder P Singh.Eligibility traces for off-policy policy evaluation.In Proceedings of ICML, 2000.
RCG
+
 [15]
Andrei A Rusu, Sergio Gomez Colmenarejo, Caglar Gulcehre, Guillaume Desjardins, James Kirkpatrick, Razvan Pascanu, Volodymyr Mnih, Koray Kavukcuoglu, and Raia Hadsell.Policy distillation.arXiv preprint arXiv:1511.06295, 2015.
RWC
+
 [19]
Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, and Ilya Sutskever.Language models are unsupervised multitask learners.OpenAI Technical report, 2019.
SCGL [19]
Siqi Sun, Yu Cheng, Zhe Gan, and Jingjing Liu.Patient knowledge distillation for BERT model compression.In Proceedings EMNLP, 2019.
SDCW [19]
Victor Sanh, Lysandre Debut, Julien Chaumond, and Thomas Wolf.DistilBERT, a distilled version of bert: smaller, faster, cheaper and lighter.arXiv preprint arXiv:1910.01108, 2019.
SHKK [22]
Joar Max Viktor Skalse, Nikolaus HR Howe, Dmitrii Krasheninnikov, and David Krueger.Defining and characterizing reward gaming.In Proceedings of NeurIPS, 2022.
SMSM [99]
Richard S Sutton, David McAllester, Satinder Singh, and Yishay Mansour.Policy gradient methods for reinforcement learning with function approximation.Proceedings of NeurIPS, 1999.
SPW
+
 [13]
Richard Socher, Alex Perelygin, Jean Wu, Jason Chuang, Christopher D. Manning, Andrew Ng, and Christopher Potts.Recursive deep models for semantic compositionality over a sentiment treebank.In Proceedings of EMNLP, October 2013.
SSG
+
 [17]
Iulian V Serban, Chinnadhurai Sankar, Mathieu Germain, Saizheng Zhang, Zhouhan Lin, Sandeep Subramanian, Taesup Kim, Michael Pieper, Sarath Chandar, Nan Rosemary Ke, et al.A deep reinforcement learning chatbot.arXiv preprint arXiv:1709.02349, 2017.
SST
+
 [20]
Kaitao Song, Hao Sun, Xu Tan, Tao Qin, Jianfeng Lu, Hongzhi Liu, and Tie-Yan Liu.LightPAFF: A two-stage distillation framework for pre-training and fine-tuning.arXiv preprint arXiv:2004.12817, 2020.
SWD
+
 [17]
John Schulman, Filip Wolski, Prafulla Dhariwal, Alec Radford, and Oleg Klimov.Proximal policy optimization algorithms.arXiv preprint arXiv:1707.06347, 2017.
SWR
+
 [22]
Victor Sanh, Albert Webson, Colin Raffel, Stephen H Bach, Lintang Sutawika, Zaid Alyafeai, et al.Multitask prompted training enables zero-shot task generalization.In Proceedings of ICLR, 2022.
TDFH
+
 [22]
Romal Thoppilan, Daniel De Freitas, Jamie Hall, Noam Shazeer, Apoorv Kulshreshtha, Heng-Tze Cheng, Alicia Jin, Taylor Bos, Leslie Baker, Yu Du, et al.Lamda: Language models for dialog applications.arXiv preprint arXiv:2201.08239, 2022.
TGZ
+
 [23]
Rohan Taori, Ishaan Gulrajani, Tianyi Zhang, Yann Dubois, Xuechen Li, Carlos Guestrin, Percy Liang, and Tatsunori B. Hashimoto.Stanford Alpaca: An instruction-following LLaMA model.https://github.com/tatsu-lab/stanford_alpaca, 2023.
TLI
+
 [23]
Hugo Touvron, Thibaut Lavril, Gautier Izacard, Xavier Martinet, Marie-Anne Lachaux, Timothée Lacroix, Baptiste Rozière, Naman Goyal, Eric Hambro, Faisal Azhar, Aurelien Rodriguez, Armand Joulin, Edouard Grave, and Guillaume Lample.LLaMA: Open and efficient foundation language models.arXiv preprint arXiv:2302.13971, 2023.
TWS [18]
Faraz Torabi, Garrett Warnell, and Peter Stone.Behavioral cloning from observation.In Proceedings of IJCAI, 2018.
WBH
+
 [21]
Wenhui Wang, Hangbo Bao, Shaohan Huang, Li Dong, and Furu Wei.MiniLMv2: Multi-head self-attention relation distillation for compressing pretrained transformers.In Findings of ACL, 2021.
WBZ
+
 [22]
Jason Wei, Maarten Bosma, Vincent Y Zhao, Kelvin Guu, Adams Wei Yu, Brian Lester, Nan Du, Andrew M Dai, and Quoc V Le.Finetuned language models are zero-shot learners.In Proceedings of ICLR, 2022.
Wil [92]
Ronald J Williams.Simple statistical gradient-following algorithms for connectionist reinforcement learning.Machine learning, 1992.
WK [21]
Ben Wang and Aran Komatsuzaki.GPT-J-6B: A 6 Billion Parameter Autoregressive Language Model, 2021.
WKM
+
 [23]
Yizhong Wang, Yeganeh Kordi, Swaroop Mishra, Alisa Liu, Noah A. Smith, Daniel Khashabi, and Hannaneh Hajishirzi.Self-instruct: Aligning language models with self-generated instructions.In Proceedings of ACL, 2023.
WLDM [23]
Yuqiao Wen, Zichao Li, Wenyu Du, and Lili Mou.f-divergence minimization for sequence-level knowledge distillation.In Proceedings of ACL, 2023.
WMA
+
 [22]
Yizhong Wang, Swaroop Mishra, Pegah Alipoormolabashi, Yeganeh Kordi, Amirreza Mirzaei, Anjana Arunkumar, Arjun Ashok, Arut Selvan Dhanasekaran, Atharva Naik, David Stap, et al.Benchmarking generalization via in-context instructions on 1,600+ language tasks.In Proceedings of EMNLP, 2022.
WTB
+
 [22]
Jason Wei, Yi Tay, Rishi Bommasani, Colin Raffel, Barret Zoph, Sebastian Borgeaud, Dani Yogatama, Maarten Bosma, Denny Zhou, Donald Metzler, et al.Emergent abilities of large language models.Transactions on Machine Learning Research, 2022.
WWD
+
 [20]
Wenhui Wang, Furu Wei, Li Dong, Hangbo Bao, Nan Yang, and Ming Zhou.MiniLM: Deep self-attention distillation for task-agnostic compression of pre-trained transformers.In Proceedings of NeurIPS, 2020.
WWZ
+
 [23]
Minghao Wu, Abdul Waheed, Chiyu Zhang, Muhammad Abdul-Mageed, and Alham Fikri Aji.Lamini-lm: A diverse herd of distilled models from large-scale instructions.arXiv preprint arXiv:2304.14402, 2023.
ZCS
+
 [23]
Lianmin Zheng, Wei-Lin Chiang, Ying Sheng, Siyuan Zhuang, Zhanghao Wu, Yonghao Zhuang, Zi Lin, Zhuohan Li, Dacheng Li, Eric Xing, et al.Judging llm-as-a-judge with mt-bench and chatbot arena.In Proceedings of NeurIPS, 2023.
ZLX
+
 [23]
Chunting Zhou, Pengfei Liu, Puxin Xu, Srinivasan Iyer, Jiao Sun, Yuning Mao, Xuezhe Ma, Avia Efrat, Ping Yu, Lili Yu, et al.LIMA: Less is more for alignment.In Proceedings of NeurIPS, 2023.
ZMB
+
 [08]
Brian D Ziebart, Andrew L Maas, J Andrew Bagnell, Anind K Dey, et al.Maximum entropy inverse reinforcement learning.In Proceedings of AAAI, 2008.
ZRG
+
 [22]
Susan Zhang, Stephen Roller, Naman Goyal, Mikel Artetxe, Moya Chen, Shuohui Chen, Christopher Dewan, Mona Diab, Xian Li, Xi Victoria Lin, et al.OPT: Open pre-trained transformer language models.arXiv preprint arXiv:2205.01068, 2022.
ZSL
+
 [23]
Rongzhi Zhang, Jiaming Shen, Tianqi Liu, Jialu Liu, Michael Bendersky, Marc Najork, and Chao Zhang.Do not blindly imitate the teacher: Using perturbed loss for knowledge distillation.arXiv preprint arXiv:2305.05010, 2023.
ZZ [19]
Huan Zhang and Hai Zhao.Minimum divergence vs. maximum margin: an empirical comparison on seq2seq models.In International Conference on Learning Representations, 2019.
Appendix ADerivations
A.1A Perspective of MiniLLM from Inverse Reinforcement Learning
In Section 2.1, we formulate KD as an optimization problem of minimizing the discrepancy between the teacher distribution and the student distribution and finally reach the objective of minimizing reverse KLD. Alternatively, we can also regard KD as training the student model with the teacher model’s guidance, which resembles an agent learning from the feedback from an environment. Following [52], we treat token generation as a Markov Decision Process. At each time step 
𝑡
, the student model chooses an action (token) 
𝑦
𝑡
 from the action space (vocabulary) 
𝑉
 conditioning on the state (prefix) 
(
𝒚
<
𝑡
,
𝒙
)
 based on the policy (generation probability) 
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
.

From this perspective, standard KD corresponds to behavior cloning (BC; 69) in imitation learning [13]. However, BC is known to under-perform Inverse Reinforcement Learning (IRL; 82), another imitation learning method that first recovers a reward model from the environment demonstrations and then trains the policy with the reward using policy optimization algorithms [60, 64]. Therefore, in the KD scenario, we seek to first induce a reward 
𝑟
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
 from the environment (the teacher model) and then train the student model to maximize the reward as the objective. We take the maximum-entropy inverse reinforcement learning framework [82, 18] and thus the Q-function 
𝑄
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
 in the environment satisfies the soft Bellman Equation:

𝑄
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
=
𝑟
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
+
𝛾
⁢
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑄
⁢
(
𝑦
′
,
(
𝒚
≤
𝑡
,
𝒙
)
)
]
.
(8)
We follow [24] to parameterize the Q-function as 
𝑄
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
=
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
 and assume 
𝛾
=
1
, where 
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
 is the output logits of the teacher model4. Then, the reward is given by:

𝑟
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
=
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
−
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑓
⁢
(
𝑦
′
,
(
𝒚
≤
𝑡
,
𝒙
)
)
]
.
(9)
To maximize the reward, we apply maximum-entropy reinforcement learning [26], whose learning objective is

max
𝜃
𝒥
(
𝜃
)
=
max
𝜃
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
|
𝒚
|
[
𝑟
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
+
H
[
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
]
]
,
(10)
where 
H
[
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
]
=
−
𝔼
𝑦
𝑡
∼
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
log
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
 is the entropy of the student model distribution at the time step 
𝑡
.

Equivalence Between Objectives
We prove an approximate equivalence between Eq. 10 and Eq. 1. We first rewrite the summation of the reward 
∑
𝑡
=
1
|
𝒚
|
𝑟
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
 by the associative law:

∑
𝑡
=
1
|
𝒚
|
𝑟
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
=
∑
𝑡
=
1
|
𝒚
|
[
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
−
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑓
⁢
(
𝑦
′
,
(
𝒚
≤
𝑡
,
𝒙
)
)
]
]
(11)
=
𝑓
⁢
(
𝑦
1
,
(
𝒚
<
1
,
𝒙
)
)
+
∑
𝑡
=
2
|
𝒚
|
[
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
−
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑓
⁢
(
𝑦
′
,
(
𝒚
<
𝑡
,
𝒙
)
)
]
]
(12)
−
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑓
⁢
(
𝑦
′
,
(
𝒚
≤
|
𝒚
|
,
𝒙
)
)
]
(13)
≈
∑
𝑡
=
1
|
𝒚
|
[
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
−
log
⁢
∑
𝑦
′
∈
𝑉
exp
⁡
[
𝑓
⁢
(
𝑦
′
,
(
𝒚
<
𝑡
,
𝒙
)
)
]
]
(14)
=
∑
𝑡
=
1
|
𝒚
|
log
⁡
exp
⁡
(
𝑓
⁢
(
𝑦
𝑡
,
(
𝒚
<
𝑡
,
𝒙
)
)
)
∑
𝑦
′
∈
𝑉
exp
⁡
(
𝑓
⁢
(
𝑦
′
,
(
𝒚
<
𝑡
,
𝒙
)
)
)
(15)
=
∑
𝑡
=
1
|
𝒚
|
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
.
(16)
Then, 
𝒥
⁢
(
𝜃
)
 can be approximately rewritten as:

𝒥
⁢
(
𝜃
)
≈
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
|
𝒚
|
[
log
𝑝
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
+
H
[
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
]
]
(19)
=
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
|
𝒚
|
[
log
𝑝
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
−
log
[
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
]
]
(22)
=
−
KL
(
𝑞
𝜃
|
|
𝑝
)
(23)
=
−
ℒ
⁢
(
𝜃
)
.
(24)
Therefore, maximizing 
𝒥
⁢
(
𝜃
)
 is approximately equivalent to minimizing 
ℒ
⁢
(
𝜃
)
.

A.2Derivation of Equation 2
We compute the gradient of 
ℒ
(
𝜃
)
=
KL
[
𝑞
𝜃
|
|
𝑝
]
 with respect to 
𝜃
 using the Policy Gradient Theorem [60]:

∇
ℒ
⁢
(
𝜃
)
=
−
∇
⁢
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
(25)
=
−
∫
∇
[
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
]
⁡
d
⁢
𝒚
⁢
d
⁢
𝒙
=
−
∫
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
∇
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
d
⁢
𝒚
⁢
d
⁢
𝒙
−
∫
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
∇
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
d
𝒚
⁢
d
𝒙
=
∫
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
d
𝒚
⁢
d
𝒙
−
∫
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
⁢
d
𝒚
⁢
d
𝒙
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
(
log
⁡
𝑝
⁢
(
𝒚
|
𝒙
)
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
(
∑
𝑡
′
=
1
𝑇
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
(
∑
𝑡
′
=
𝑡
𝑇
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
,
where Eq. 25 is based on the fact that 
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
 can only affect tokens at 
≥
𝑡
 positions in 
𝒚
. By setting 
𝑅
𝑡
=
∑
𝑡
′
=
𝑡
𝑇
log
⁡
𝑝
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
′
|
𝒚
<
𝑡
′
,
𝒙
)
, we obtain Eq. 2.

A.3Derivation of Equation 3
To derive Eq. 3, we first denote:

(
∇
ℒ
)
Single
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
[
∑
𝑡
=
1
𝑇
∇
⁢
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
]
,
(26)
(
∇
ℒ
)
Long
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
𝑅
𝑡
+
1
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
.
Then, we re-write 
∇
ℒ
⁢
(
𝜃
)
 as:

∇
ℒ
⁢
(
𝜃
)
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
(
𝑅
𝑡
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
(29)
=
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
𝑅
𝑡
+
1
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
(32)
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
(
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
(35)
=
(
∇
ℒ
)
Long
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
𝔼
𝑦
𝑡
∼
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
(
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
−
1
)
⁢
∇
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
(38)
=
(
∇
ℒ
)
Long
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
∑
𝑡
=
1
𝑇
∇
⁢
𝔼
𝑦
𝑡
∼
𝑞
𝜃
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
[
−
log
⁡
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
]
(41)
=
(
∇
ℒ
)
Long
−
𝔼
𝒙
∼
𝑝
𝒙
𝒚
∼
𝑞
𝜃
(
⋅
|
𝒙
)
[
∑
𝑡
=
1
𝑇
∇
⁢
𝔼
𝑦
𝑡
∼
𝑞
𝜃
⁢
(
𝑡
)
[
𝑟
𝑡
]
]
(44)
=
(
∇
ℒ
)
Long
+
(
∇
ℒ
)
Single
,
(45)
where Eq. 41 uses the product rule of the gradient and 
𝑟
𝑡
=
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
.

Appendix BExperimental Details
B.1Training Details
Baselines
Our baselines include SFT w/o KD, KD, and SeqKD. For models with less than 1.3B parameters, we search for the learning rates in [5e-4, 1e-4, 5e-5], the batch sizes in [32, 64], and train these models for 20 epochs. For other models, we search for the learning rate in [5e-5, 1e-5, 5e-6], the batch sizes in [32, 64], and train these models for 10 epochs. For KD, we follow [63] to mix the distillation loss with the language modeling loss on the ground truth responses by a mixture rate of 0.5. The checkpoints of each baseline are selected by the Rouge-L [39] scores on the validation set because, as stated in previous works [76, 51], we also find that Rouge-L is better correlated with human judgments.

MiniLLM
As stated in Section 2.3, training of MiniLLM has two phases which is similar to Reinforcement Learning from Human Feedback (RLHF;51).

• Phase 1: We fine-tune the student model on the instruction-response training set 
𝒟
 to get a starting point for the subsequent MiniLLM training. We fine-tune the model for 3 epochs using the best learning rate and batch size of the corresponding SFT w/o KD baselines. Note that different from the SFT w/o KD baseline, we select the checkpoint with the lowest validation loss, not the Rouge-L score in this phase.
• Phase 2: We continuously train the model from Phase 1 as described in Algorithm 1 using a learning rate 5e-6, a mini-batch size 
64
 in all cases. The training and validation set are same as in Phase 1. Similar to [51], we collect 256 sentences at once and adopt 4 inner epochs when doing the policy optimization. The clipping rate 
𝜖
 is set to 0.2, and the max length of the model is 512. We use temperature = 1 when sampling from 
𝑞
𝜃
. We train the model for 5000 steps and select the final checkpoint using the Rouge-L score on the validation set. Our experiments are based on the NVIDIA V100 32G GPUs. Distilling LLaMA-7B from LLaMA-13B takes less than 10 ours on 16 GPUs.
B.2Automatic Evaluation Details
During the evaluation, we sample the responses from each model using temperature = 1, a max-length limit of 512, and random seeds [10, 20, 30, 40, 50]. Similar to [67], we adopt a prompt wrapper shown in Figure 9 to convert each instruction-response pair to a sentence. For the GPT-4 feedback, we apply the prompt in Figure 10 and set the temperature = 0.7. For the classification tasks in the “Calibration” paragraph of Section 3.3, we prompt the model to do zero-shot text classification with the templates in Figure 11 and 12.


Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
{instruction}
### Input:
{input}
### Response:

Figure 9:The prompt wrapper for training and evaluation.

We would like to request your feedback on the performance of two AI assistants in response to the user instruction and input displayed above.
Please rate the helpfulness, relevance, accuracy, and level of detail of their responses. Each assistant receives an overall score on a scale of 1 to 10, where a higher score indicates better overall performance.
Please first output a single line containing only two values indicating the scores for Assistant 1 and 2, respectively. The two scores are separated by a space.
In the subsequent line, please provide a comprehensive explanation of your evaluation, avoiding any potential bias and ensuring that the order in which the responses were presented does not affect your judgment.

Figure 10:GPT-4 evaluation prompt.

Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
Determine the sentiment of the input sentence. Please respond as positive or negative.
### Input:
{sentence}
### Response:

Figure 11:Zero-shot text classification prompt for SST2.

Below is an instruction that describes a task.
Write a response that appropriately completes the request.
### Instruction:
Read the input passage and answer the question: {question}? Your answer should be “Yes” or “No”.
### Input:
{passage}
### Response:

Figure 12:Zero-shot text classification prompt for BoolQ.
B.3Human Evaluation Details
Following [53], we use SelfInst [74] to perform human evaluation. We randomly sampled 50 prompts because we found that more prompts do not affect the results much. We ask the annotators to compare the responses generated by the baseline models with MiniLLM and decide which response is preferred or neither of them is significantly better. Note that which model the responses come from is invisible to the annotators. The interface presented to annotators is shown in Figure 13.


Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.
### Instruction:
Desk jobs require writing a lot of emails, so it isn’t surprising we get tired of repeating ourselves. Come up with several synonyms for the given word.
### Input:
Sincerely
### Response:
##### Answer #1 #####
Fondly, affectionately, lovingly, tenderly, honestly, truly, faithfully, devotedly, passionately
##### Answer #2 #####
Faithfully, Gullibly, Humbly, Piously, Strangely, Weirdly, Yours truly
1: Answer #1 is better
2: Answer #2 is better
3: Tie
Your choice:

Figure 13:The prompt wrapper for training and evaluation.
B.4Details About Generation Diversity Metrics
In Table 7, we report the distinct 4-grams (Dist-4) and the language modeling loss (Loss) on the test sets. More details about these two metrics are as follows:

• “Dist-4” is a fraction: 
𝑁
/
𝐶
 , where 
𝑁
 is the number of the distinct 4-grams in the generated responses and 
𝐶
 is the total number of 4-grams. It is a widely used metric to measure the generation diversity of a language model [37]. The 
(
𝑁
/
𝐶
)
s on the Dolly test set across 5 random seeds are shown in Table 5. Table 7 reports the average values across the 5 random seeds.
• “Loss” is the negative log-likelihood loss on the test set 
𝒟
Test
: 
−
∑
𝒙
,
𝒚
∼
𝒟
Test
log
⁡
𝑞
𝜃
⁢
(
𝒚
|
𝒙
)
. It measures the mode coverage of the real data distribution because it is essentially the forward KLD between the real data distribution and the model output distribution. This relates to diversity as in the ability to generate different generations given one context with different random seeds.
Model
Seed
10	20	30	40	50
Teacher	23562 / 23696	23653 / 23834	24306 / 24488	24207 / 24381	23803 / 23967
KD	25889 / 26064	24024 / 24197	25663 / 25843	25611 / 25763	26178 / 26339
SeqKD	25358 / 25519	25631 / 25822	26190 / 26370	25574 / 25748	26295 / 26522
MiniLLM	24187 / 24458	25011 / 25272	25100 / 25436	24067 / 24312	25205 / 25519
Table 5:The (
𝑁
/
𝐶
)s, where 
𝑁
 is the number of the distinct 4-grams in the generated responses and 
𝐶
 is the total number of 4-grams. We report the numbers computed on the Dolly test set when evaluated with 5 random seeds: [10, 20, 30, 40, 50].
B.5Exposure Bias Analysis
Following [2], we compute the ExAccErr with the following formula:

ExAccErr
⁢
(
𝑙
)
=
𝑅
⁢
(
𝑙
)
−
𝑙
⁢
𝜖
⁢
(
𝑙
)
𝑙
⁢
𝜖
⁢
(
𝑙
)
×
100
%
,
(46)
where 
𝑅
⁢
(
𝑙
)
 is the accumulated regret of imitating the teacher distribution 
𝑝
 at the time step 
𝑙
 during the free-run generation:

𝑅
⁢
(
𝑙
)
=
∑
𝑡
=
1
𝑇
𝔼
𝒚
<
𝑡
∼
𝑞
𝜃
(
⋅
|
𝒙
)
𝑦
𝑡
∼
𝑝
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
,
(47)
and 
𝜖
⁢
(
𝑙
)
 is the average per-step error between 
𝑞
𝜃
 and 
𝑝
 using the oracle context sampled from 
𝑝
 as the prefix:

𝜖
⁢
(
𝑙
)
=
1
𝑙
⁢
∑
𝑡
=
1
𝑇
𝔼
𝒚
<
𝑡
∼
𝑝
(
⋅
|
𝒙
)
𝑦
𝑡
∼
𝑝
(
⋅
|
𝒚
<
𝑡
,
𝒙
)
log
⁡
𝑝
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
𝑞
𝜃
⁢
(
𝑦
𝑡
|
𝒚
<
𝑡
,
𝒙
)
.
(48)
Intuitively, the regret of 
𝑞
𝜃
 during generation is made of two parts: the error to estimate 
𝑝
 given the oracle context and the error caused by the low-quality model-generated prefix. The former is calculated by 
𝑙
⁢
𝜖
⁢
(
𝑙
)
, and the latter reflects the exposure bias. Therefore, ExAccErr measures the relative error caused only by exposure bias.

Appendix CAdditional Results
C.1GPT-J as the Teacher Model
We present the evaluation results when using GPT-J as the teacher model and GPT-2-760M, GPT-2-1.5B, and GPT-Neo-2.7B [6] as the student models in Table 6. MiniLLM outperforms the baselines in most cases.

Model	Method	DollyEval	SelfInst	VicunaEval	S-NI	UnNI
GPT4	R-L	GPT4	R-L	GPT4	R-L	R-L	R-L
GPT-J-6B	Teacher	65.8	27.3	57.4	17.3	55.8	17.4	28.0	33.6
GPT-2-760M	SFT w/o KD	50.7	25.4	38.3	12.4	43.1	16.1	21.5	27.1
KD	51.6	26.7	38.9	13.4	43.4	16.4	25.9	33.2
SeqKD	51.4	26.0	39.2	14.0	42.0	15.3	25.5	32.5
MiniLLM	54.0	25.8	43.7	16.3	44.3	19.1*	27.1	35.5*
GPT-2-1.5B	SFT w/o KD	58.4	27.6*	42.9	14.3	48.6	16.3	27.6	34.6*
KD	56.5	26.6	46.0	14.5	47.2	16.5	27.6	34.9*
SeqKD	58.5	27.0	43.2	13.6	46.6	16.9	28.0	34.2*
MiniLLM	59.6	25.9	48.5	16.6	48.9	19.4*	28.5*	35.9*
GPT-Neo-2.7B	SFT w/o KD	60.7	26.8	45.4	15.8	51.5	17.0	26.5	31.6
KD	61.5	26.7	47.0	16.0	52.1	16.9	27.2	32.7
SeqKD	60.8	25.6	47.2	16.2	53.0	16.9	26.1	32.9
MiniLLM	63.4	28.5*	52.5	17.1	54.1	18.6*	29.8*	35.4*
Table 6:Evaluation results when GPT-J is the teacher. GPT4 and R-L stand for the average GPT-4 feedback scores and Rouge-L scores across 5 random seeds. The best scores of each model size are boldfaced, and the scores where the student model outperforms the teacher are marked with *.
Figure 14:The scaling law of teacher model based on the OPT family models. We compare MiniLLM and SeqKD with OPT-1.3M as the student and OPT 2.7B, 6.7B, and 13B as teachers.
Refer to caption
Refer to caption
Figure 14:The scaling law of teacher model based on the OPT family models. We compare MiniLLM and SeqKD with OPT-1.3M as the student and OPT 2.7B, 6.7B, and 13B as teachers.
Figure 15:The Rouge-L scores of the distilled models against the SFT models on the different evaluation subsets of UnNI split by the golden responses’ length.
C.2Scaling Law of Teacher based on the OPT family
We present the performance of MiniLLM and SeqKD when we scale up the sizes of teacher models in Figure 15. Similar to the observations in Section 3.3, MiniLLM constantly performs better and distills better student models from larger teacher models.

C.3Performance of Response Length on U-NI
The performance on different U-NI subsets split by the length of the ground truth response is shown in Figure 15. We have the same observation as in Section 3.3 that on short responses, all KD methods perform similarly, and on long responses, MiniLLM outperforms other methods.

Figure 16:Effect of the 
𝛼
 value in the teacher mix-in exploration on the validation Rouge-L score. Larger models to more robust to 
𝛼
.
Refer to caption
CLS	Inst.
1.3B	MiniLLM	70.2	52.8
  w/o 
ℒ
PT
65.7	53.2
7B	MiniLLM	78.8	71.2
  w/o 
ℒ
PT
74.3	71.1 
Figure 16:Effect of the 
𝛼
 value in the teacher mix-in exploration on the validation Rouge-L score. Larger models to more robust to 
𝛼
.
Table 7:The effect of adding the pre-training loss. “CLS” is the average accuracy scores on SST2 and BoolQ. “Inst.” is the average Rouge-L score on Dolly, SelfInst, and Vicuna.
C.4More Ablation Studies
Effect of Teacher-Mix-in Strength 
𝛼
In Figure 16, we plot the best Rouge-L scores on the validation set of GPT-2-125M, OPT-1.3B, and LLaMA-7B using GPT-2-1.5B, OPT-13B, and LLAMA-13B as the teachers, with different teacher-mix-in strength 
𝛼
 in MiniLLM. 
𝛼
=
0.0
 means we only sample from the student distribution, and when 
𝛼
=
1.0
, we sample entirely from the teacher distribution. We find that 
𝛼
=
0.2
 is generally suitable across different model families and sizes, and larger models are more robust to the choice of 
𝛼
.

Effect of Adding Pre-Training Loss
In Table 16, we study the effect of adding the pre-training loss in Algorithm 1 by comparing MiniLLM with its variant where the language modeling loss on the pre-training corpus is removed (w/o 
ℒ
PT
). We have a similar observation as [51] that adding the pre-training loss helps to preserve the abilities on canonical NLP tasks while keeping the performance on instruction-following tasks nearly unchanged.

Appendix DCases
We provide some cases generated by the models distilled by different methods based on the LLaMA model family in Table 8. The prompts are sampled from the SelfInst dataset. We find that MiniLLM generates more detailed and accurate responses compared with the baselines.

Case #1
Instruction	
During writing, we added an asterisk for the word that did not come to mind. You will need to provide several examples to demonstrate all the words that can be used in the sentence instead of the asterisk.

Input	
we * to know

SFT w/o KD	
We can use “know” in the sentence instead of “we * to know”

KD	
we went to know
\
n we will go to know
\
n we can go to know
\
n we may go to know
\
n we should go to know
\
n we must go to know

SeqKD	
we do to know
\
n we can do to know
\
n we should do to know
\
n we would do to know
\
n we ought to do to know

MiniLLM	
We can use the following words in place of the asterisk:
\
n - want
\
n - have
\
n - do
\
n - used
\
n - ought
\
n - desire
\
n - need
\
n - must

MiniLLM
w/o teacher-mixed
We to know

Case #2
Instruction	
Take the title of the product and extract its attributes. The attributes in this case refer to the characteristics of the products, such as their brand and color. Your answer must a list following the format of “attribute: value”.

Input	
SAMSUNG 980 PRO SSD 2TB PCIe NVMe Gen 4 Gaming M.2 Internal Solid State Hard Drive Memory Card, Maximum Speed, Thermal Control, MZ-V8P2T0B

SFT w/o KD	
Attribute: Maximum Speed
\
n Value: 3500 MB/s

KD	
attribute: brand, attribute: color, attribute: memory card, attribute: maximum speed, attribute: thermal control

SeqKD	
brand: Samsung, color: black, size: 2TB, interface: PCIe NVME Gen 4, design: M.2 Internal

MiniLLM	
brand: SAMSUNG
\
n color: 980 PRO
\
n capacity: 2TB
\
n interface: PCIe NVME Gen 4
\
n speed: Maximum Speed
\
n threshold: Thermal Control
\
n form factor: M.2 Internal

MiniLLM
w/o teacher-mixed
SAMSUNGC 980 Pro SSD 2TB PCIe NVME Gen 4 Gaming M.II Internal Solid State Hard Drive memory Card, Max Speed, Thermal Control, AP1500K

Table 8:Instruction-following cases from the SelfInst dataset. MiniLLM better follows the instructions and provides more detailed and accurate responses. Without the teacher-mixed sampling strategy in Section 2.2, the distilled model outputs short responses (Case #1) or simply repeats the input (Cases #2).